<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xiaozhi WebSocket Test</title>
    <!-- Opus decoder library for Web Audio API -->
    <script src="https://cdn.jsdelivr.net/npm/@wasm-audio-decoders/opus@0.1.11/dist/opus-decoder.min.js"></script>
    <script>
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
        let opusDecoderAvailable = false;
        window.addEventListener('load', () => {
            setTimeout(() => {
                if (typeof OpusDecoder !== 'undefined') {
                    opusDecoderAvailable = true;
                    console.log('‚úÖ OpusDecoder –∑–∞–≥—Ä—É–∂–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é');
                } else {
                    console.warn('‚ö†Ô∏è OpusDecoder –Ω–µ –Ω–∞–π–¥–µ–Ω - –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω fallback');
                }
            }, 500); // –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
        });
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .responses-container {
            margin-top: 20px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        .response-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 15px;
        }
        .panel {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
        }
        .panel h3 {
            margin-top: 0;
        }
        textarea {
            width: 100%;
            min-height: 100px;
            font-family: monospace;
            font-size: 12px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
        }
        .status.connected {
            background: #d4edda;
            color: #155724;
        }
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 3px;
            padding: 10px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 11px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #007bff;
            padding-left: 10px;
        }
        .log-entry.sent {
            border-left-color: #28a745;
        }
        .log-entry.received {
            border-left-color: #ffc107;
        }
        .log-entry.error {
            border-left-color: #dc3545;
        }
        input[type="text"] {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            box-sizing: border-box;
        }
        .response-box {
            background: #f4f6fb;
            border: 1px solid #d9e2f6;
            border-radius: 4px;
            min-height: 90px;
            padding: 10px;
            font-family: monospace;
            font-size: 13px;
            white-space: pre-wrap;
            word-break: break-word;
            transition: background 0.4s ease;
        }
        .response-box.flash {
            background: #fff6d6;
            border-color: #ffe08a;
        }
        .audio-response-list {
            margin-top: 10px;
        }
        .audio-response {
            border: 1px dashed #cdd8f4;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
            background: #fff;
        }
        .audio-response__meta {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #555;
            margin-bottom: 6px;
        }
        .audio-response a {
            font-size: 12px;
            color: #007bff;
            text-decoration: none;
            margin-left: 10px;
        }
        .audio-response a:hover {
            text-decoration: underline;
        }
        .audio-placeholder {
            font-size: 13px;
            color: #666;
            margin: 0;
        }
    </style>
</head>
<body>
    <h1>MediaRise Robot Console - WebSocket Test Client</h1>
    <p><strong>–û—Ç–ø—Ä–∞–≤–∫–∞ –≥–æ–ª–æ—Å–∞ –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ —Ç–µ–∫—Å—Ç–æ–º –∏ –≥–æ–ª–æ—Å–æ–º</strong></p>
    
    <div class="container">
        <div class="panel">
            <h3>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</h3>
            <input type="text" id="wsUrl" value="ws://localhost:8080/ws" placeholder="WebSocket URL">
            <div style="margin: 10px 0;">
                <label for="audioFormat">–§–æ—Ä–º–∞—Ç –∞—É–¥–∏–æ –æ—Ç–≤–µ—Ç–∞:</label>
                <select id="audioFormat" style="margin-left: 10px; padding: 5px;">
                    <option value="opus">Opus</option>
                    <option value="mp3">MP3</option>
                </select>
                <small style="display: block; margin-top: 5px; color: #666;">
                    –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç –∞—É–¥–∏–æ –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞. MP3 –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–∞–º–∏ –Ω–∞–ø—Ä—è–º—É—é, Opus —Ç—Ä–µ–±—É–µ—Ç –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è.
                </small>
            </div>
            <div>
                <button id="connectBtn" onclick="connect()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
                <button id="disconnectBtn" onclick="disconnect()" disabled>–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
            </div>
            <div id="status" class="status disconnected">–û—Ç–∫–ª—é—á–µ–Ω–æ</div>
        </div>
        
        <div class="panel">
            <h3>–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π</h3>
            <label>–¢–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è:</label>
            <select id="messageType">
                <option value="hello">Hello (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–≤—ã–º)</option>
                <option value="listen">Listen (–æ—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞)</option>
                <option value="stt">STT (—Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è)</option>
                <option value="tts">TTS (—Å–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏)</option>
                <option value="llm">LLM (–∑–∞–ø—Ä–æ—Å –∫ LLM)</option>
                <option value="goodbye">Goodbye</option>
            </select>
            <textarea id="messageBody" placeholder='JSON —Å–æ–æ–±—â–µ–Ω–∏–µ (–∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏)'>{
  "type": "hello",
  "version": 3,
  "transport": "websocket",
  "features": {
    "aec": true,
    "mcp": false
  },
  "audio_params": {
    "format": "opus",
    "sample_rate": 48000,
    "channels": 1,
    "frame_duration": 20
  }
}</textarea>
            <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å JSON</button>
            <button onclick="sendHello()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å Hello</button>
            <hr>
            <h4>üé§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∞—É–¥–∏–æ —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞</h4>
            <div id="audioControls">
                <button id="startRecordBtn" onclick="startRecording()" disabled>üé§ –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å</button>
                <button id="stopRecordBtn" onclick="stopRecording()" style="display:none;">‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
                <button id="sendAudioBtn" onclick="sendRecordedAudio()" disabled>üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å–∞–Ω–Ω–æ–µ –∞—É–¥–∏–æ</button>
            </div>
            <div id="audioStatus" style="margin-top: 10px; padding: 5px; background: #f0f0f0; border-radius: 3px; font-size: 12px;">
                –°—Ç–∞—Ç—É—Å: –ù–µ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è
            </div>
            <div id="audioLevel" style="margin-top: 5px; height: 20px; background: #ddd; border-radius: 3px; overflow: hidden;">
                <div id="audioLevelBar" style="height: 100%; width: 0%; background: #28a745; transition: width 0.1s;"></div>
            </div>
            <hr>
            <h4>üìù –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞ (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞)</h4>
            <p><small>–ï—Å–ª–∏ –Ω–µ—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞, –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç –Ω–∞–ø—Ä—è–º—É—é</small></p>
            <button onclick="sendListenWithText()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç (Listen)</button>
        </div>
    </div>
    
    <div class="responses-container">
        <div class="panel">
            <h3>–û—Ç–≤–µ—Ç—ã —Å–µ—Ä–≤–µ—Ä–∞</h3>
            <div class="response-grid">
                <div>
                    <h4>üìù –ü–æ—Å–ª–µ–¥–Ω—è—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è (STT)</h4>
                    <div id="sttOutput" class="response-box">–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
                </div>
                <div>
                    <h4>ü§ñ –û—Ç–≤–µ—Ç LLM</h4>
                    <div id="llmOutput" class="response-box">–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
                </div>
            </div>
            <h4 style="margin-top:20px;">üîä –ê—É–¥–∏–æ –æ—Ç–≤–µ—Ç—ã</h4>
            <div id="audioResponses" class="audio-response-list">
                <p id="audioPlaceholder" class="audio-placeholder">
                    –ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥–æ–ª–æ—Å–∞ —Å—é–¥–∞ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∞—É–¥–∏–æ –æ—Ç–≤–µ—Ç—ã —Å–µ—Ä–≤–µ—Ä–∞
                </p>
            </div>
        </div>
    </div>
    
    <div class="panel">
        <h3>–õ–æ–≥ —Å–æ–æ–±—â–µ–Ω–∏–π</h3>
        <button onclick="clearLog()">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
        <div id="log" class="log"></div>
    </div>

    <script>
        let ws = null;
        let sessionId = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let audioStream = null;
        let audioContext = null;
        let analyser = null;
        let isRecording = false;
        let audioLevelInterval = null;
        let pendingResponseTimer = null;
        const highlightTimers = {};

        function updateStatus(connected) {
            const status = document.getElementById('status');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            const startRecordBtn = document.getElementById('startRecordBtn');
            
                if (connected) {
                status.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
                status.className = 'status connected';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                if (sessionId) {
                    document.getElementById('startRecordBtn').disabled = false;
                }
            } else {
                status.textContent = '–û—Ç–∫–ª—é—á–µ–Ω–æ';
                status.className = 'status disconnected';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                document.getElementById('startRecordBtn').disabled = true;
                if (isRecording) {
                    stopRecording();
                }
            }
        }

        function addLog(message, type = 'info') {
            const log = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        window.clearLog = function clearLog() {
            document.getElementById('log').innerHTML = '';
        };

        // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≥–ª–æ–±–∞–ª—å–Ω—ã–º–∏ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ onclick
        window.connect = function connect() {
            const url = document.getElementById('wsUrl').value;
            addLog(`–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ ${url}...`, 'info');
            
            ws = new WebSocket(url);
            
            ws.onopen = () => {
                addLog('WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω', 'sent');
                updateStatus(true);
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º hello
                sendHello();
            };
            
            ws.onmessage = async (event) => {
                if (event.data instanceof Blob || event.data instanceof ArrayBuffer) {
                    const size = event.data instanceof Blob ? event.data.size : event.data.byteLength;
                    addLog(`üéµ –ü–æ–ª—É—á–µ–Ω—ã –±–∏–Ω–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–∞—É–¥–∏–æ –æ—Ç–≤–µ—Ç) - ${size} bytes`, 'received');
                    clearPendingResponseTimer();
                    
                    // –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ, –∑–∞—Ç–µ–º –æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–æ—Ä–º–∞—Ç –ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É
                    let arrayBuffer;
                    try {
                        if (event.data instanceof Blob) {
                            arrayBuffer = await event.data.arrayBuffer();
                        } else if (event.data instanceof ArrayBuffer) {
                            arrayBuffer = event.data;
                        } else {
                            arrayBuffer = await new Response(event.data).arrayBuffer();
                        }
                        
                        if (arrayBuffer.byteLength === 0) {
                            addLog('‚ùå –û—à–∏–±–∫–∞: –ø–æ–ª—É—á–µ–Ω –ø—É—Å—Ç–æ–π ArrayBuffer', 'error');
                            return;
                        }
                        
                        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–æ—Ä–º–∞—Ç –ø–æ –ø–µ—Ä–≤—ã–º –±–∞–π—Ç–∞–º –¥–∞–Ω–Ω—ã—Ö
                        const firstBytes = new Uint8Array(arrayBuffer.slice(0, 5));
                        const isMp3 = firstBytes[0] === 0xFF && (firstBytes[1] & 0xE0) === 0xE0; // MP3 frame sync
                        const isId3 = String.fromCharCode(firstBytes[0], firstBytes[1], firstBytes[2]) === 'ID3'; // ID3 tag
                        const isOpus = firstBytes[0] === 0x78 && (firstBytes[1] === 0x80 || firstBytes[1] === 0x81); // Opus Ogg
                        
                        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö
                        let detectedFormat = 'opus'; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                        let mimeType = 'audio/ogg;codecs=opus';
                        
                        if (isMp3 || isId3) {
                            detectedFormat = 'mp3';
                            mimeType = 'audio/mpeg';
                            addLog('‚úÖ –û–±–Ω–∞—Ä—É–∂–µ–Ω —Ñ–æ—Ä–º–∞—Ç MP3 –ø–æ –¥–∞–Ω–Ω—ã–º', 'info');
                        } else if (isOpus) {
                            detectedFormat = 'opus';
                            mimeType = 'audio/ogg;codecs=opus';
                            addLog('‚úÖ –û–±–Ω–∞—Ä—É–∂–µ–Ω —Ñ–æ—Ä–º–∞—Ç Opus –ø–æ –¥–∞–Ω–Ω—ã–º', 'info');
                        } else {
                            // –ü—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç –∏–∑ –≤—ã–±–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                            const selectedFormat = document.getElementById('audioFormat')?.value || 'opus';
                            detectedFormat = selectedFormat;
                            mimeType = selectedFormat === 'mp3' ? 'audio/mpeg' : 'audio/ogg;codecs=opus';
                            addLog(`‚ö†Ô∏è –§–æ—Ä–º–∞—Ç –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –ø–æ –¥–∞–Ω–Ω—ã–º, –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π: ${selectedFormat}`, 'warn');
                        }
                        
                        addLog(`üîç –ü–µ—Ä–≤—ã–µ –±–∞–π—Ç—ã: ${Array.from(firstBytes).map(b => '0x' + b.toString(16).padStart(2, '0')).join(' ')}`, 'info');
                        
                        // –°–æ–∑–¥–∞–µ–º Blob —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º MIME-—Ç–∏–ø–æ–º
                        const blob = new Blob([arrayBuffer], { type: mimeType });
                        addLog(`üì¶ –°–æ–∑–¥–∞–Ω Blob: ${blob.size} bytes, —Ç–∏–ø: ${blob.type}, —Ñ–æ—Ä–º–∞—Ç: ${detectedFormat}`, 'info');
                        
                        if (!blob || blob.size === 0) {
                            addLog('‚ùå –û—à–∏–±–∫–∞: Blob –ø—É—Å—Ç–æ–π –∏–ª–∏ –Ω–µ —Å–æ–∑–¥–∞–Ω', 'error');
                            return;
                        }
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–æ—Ä–º–∞—Ç –≤ data-–∞—Ç—Ä–∏–±—É—Ç–µ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ handleAudioResponse
                        blob.detectedFormat = detectedFormat;
                        handleAudioResponse(blob);
                    } catch (e) {
                        addLog(`‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${e.message}`, 'error');
                        console.error('Data processing error:', e);
                    }
                } else {
                    try {
                        const data = JSON.parse(event.data);
                        
                        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–∞–∑–Ω—ã–µ —Ç–∏–ø—ã —Å–æ–æ–±—â–µ–Ω–∏–π
                        if (data.type === 'hello' && data.session_id) {
                            sessionId = data.session_id;
                            addLog(`‚úÖ Hello –ø—Ä–∏–Ω—è—Ç! Session ID: ${sessionId}`, 'received');
                            addLog('–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∞—É–¥–∏–æ –∏–ª–∏ —Ç–µ–∫—Å—Ç', 'info');
                            const startRecordBtn = document.getElementById('startRecordBtn');
                            if (startRecordBtn) {
                                startRecordBtn.disabled = false;
                            }
                        } else if (data.type === 'stt') {
                            addLog(`üìù –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è (STT): "${data.text}"`, 'received');
                            updateSttOutput(data.text);
                            clearPendingResponseTimer();
                        } else if (data.type === 'llm') {
                            addLog(`ü§ñ –û—Ç–≤–µ—Ç LLM: "${data.text || 'N/A'}"`, 'received');
                            updateLlmOutput(data.text || '');
                            clearPendingResponseTimer();
                        } else if (data.type === 'tts') {
                            addLog(`üîä TTS: ${data.state}`, 'received');
                        } else {
                            addLog(`üì® –ü–æ–ª—É—á–µ–Ω–æ: ${JSON.stringify(data, null, 2)}`, 'received');
                        }
                    } catch (e) {
                        addLog(`–ü–æ–ª—É—á–µ–Ω–æ (—Ç–µ–∫—Å—Ç): ${event.data}`, 'received');
                    }
                }
            };
            
            ws.onerror = (error) => {
                addLog(`–û—à–∏–±–∫–∞: ${error}`, 'error');
            };
            
            ws.onclose = () => {
                addLog('WebSocket –æ—Ç–∫–ª—é—á–µ–Ω', 'error');
                updateStatus(false);
                sessionId = null;
            };
        }

        window.disconnect = function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        };

        function sendHello() {
            const audioFormat = document.getElementById('audioFormat')?.value || 'opus';
            addLog(`üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ Hello —Å —Ñ–æ—Ä–º–∞—Ç–æ–º: ${audioFormat}`, 'info');
            const hello = {
                type: "hello",
                version: 3,
                transport: "websocket",
                features: {
                    aec: true,
                    mcp: false
                },
                audio_params: {
                    format: "opus",
                    sample_rate: 48000,
                    channels: 1,
                    frame_duration: 20
                },
                audio_format: audioFormat  // –í–∞–∂–Ω–æ: –ø–µ—Ä–µ–¥–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
            };
            sendJSON(hello);
        }

        function sendListenWithText() {
            if (!sessionId) {
                addLog('–°–Ω–∞—á–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ Hello –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è session_id', 'error');
                return;
            }
            
            const text = prompt('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏:', '–ü—Ä–∏–≤–µ—Ç, –∫–∞–∫ –¥–µ–ª–∞?');
            if (!text) return;
            
            const listen = {
                type: "listen",
                session_id: sessionId,
                state: "start",
                mode: "manual",
                text: text
            };
            sendJSON(listen);
            addLog(`–û—Ç–ø—Ä–∞–≤–ª–µ–Ω —Ç–µ–∫—Å—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏: "${text}"`, 'sent');
        }

        function sendMessage() {
            const messageType = document.getElementById('messageType').value;
            const bodyText = document.getElementById('messageBody').value;
            
            let message;
            if (bodyText) {
                try {
                    message = JSON.parse(bodyText);
                } catch (e) {
                    addLog(`–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON: ${e}`, 'error');
                    return;
                }
            } else {
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ —Ç–∏–ø—É
                message = generateMessage(messageType);
            }
            
            sendJSON(message);
        }

        function generateMessage(type) {
            const base = {
                session_id: sessionId || "test-session"
            };
            
            switch(type) {
                case 'hello':
                    const audioFormat = document.getElementById('audioFormat')?.value || 'opus';
                    addLog(`üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ Hello —Å —Ñ–æ—Ä–º–∞—Ç–æ–º: ${audioFormat}`, 'info');
                    return {
                        type: "hello",
                        version: 3,
                        transport: "websocket",
                        features: { aec: true, mcp: false },
                        audio_params: {
                            format: "opus",
                            sample_rate: 48000,
                            channels: 1,
                            frame_duration: 20
                        },
                        audio_format: audioFormat  // –í–∞–∂–Ω–æ: –ø–µ—Ä–µ–¥–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
                    };
                case 'listen':
                    return {
                        type: "listen",
                        ...base,
                        state: "start",
                        mode: "manual",
                        text: "–ü—Ä–∏–≤–µ—Ç, –∫–∞–∫ –¥–µ–ª–∞?"
                    };
                case 'stt':
                    return {
                        type: "stt",
                        ...base,
                        text: "–ü—Ä–∏–≤–µ—Ç, —ç—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"
                    };
                case 'tts':
                    return {
                        type: "tts",
                        ...base,
                        state: "start",
                        text: "–ü—Ä–∏–≤–µ—Ç, —ç—Ç–æ —Ç–µ—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç"
                    };
                case 'llm':
                    return {
                        type: "llm",
                        ...base,
                        text: "–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞?"
                    };
                case 'goodbye':
                    return {
                        type: "goodbye",
                        ...base
                    };
                default:
                    return base;
            }
        }

        function sendJSON(data) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                addLog('WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω', 'error');
                return;
            }
            
            const json = JSON.stringify(data, null, 2);
            ws.send(JSON.stringify(data));
            addLog(`–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${json}`, 'sent');
        }

        // –ó–∞–ø–∏—Å—å –∞—É–¥–∏–æ
        async function startRecording() {
            if (!sessionId) {
                addLog('‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ Hello –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è session_id', 'error');
                return;
            }

            try {
                audioStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        sampleRate: 48000,
                        channelCount: 1,
                        echoCancellation: true,
                        noiseSuppression: true
                    } 
                });
                
                // –°–æ–∑–¥–∞–µ–º AudioContext –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —É—Ä–æ–≤–Ω—è
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                const source = audioContext.createMediaStreamSource(audioStream);
                source.connect(analyser);
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ MediaRecorder
                const options = {
                    mimeType: 'audio/webm;codecs=opus',
                    audioBitsPerSecond: 128000
                };
                
                try {
                    mediaRecorder = new MediaRecorder(audioStream, options);
                } catch (e) {
                    // Fallback –Ω–∞ default
                    mediaRecorder = new MediaRecorder(audioStream);
                }
                
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm;codecs=opus' });
                    addLog(`üì¶ –ó–∞–ø–∏—Å–∞–Ω–æ –∞—É–¥–∏–æ: ${audioBlob.size} bytes`, 'info');
                    document.getElementById('sendAudioBtn').disabled = false;
                };
                
                mediaRecorder.start(100); // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–µ 100–º—Å
                isRecording = true;
                
                const startBtn = document.getElementById('startRecordBtn');
                const stopBtn = document.getElementById('stopRecordBtn');
                
                startBtn.style.display = 'none';
                startBtn.disabled = true;
                stopBtn.style.display = 'inline-block';
                stopBtn.disabled = false;
                document.getElementById('audioStatus').textContent = '–°—Ç–∞—Ç—É—Å: –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è...';
                
                // –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —É—Ä–æ–≤–Ω—è –∞—É–¥–∏–æ
                audioLevelInterval = setInterval(updateAudioLevel, 100);
                
                addLog('üé§ –ó–∞–ø–∏—Å—å –Ω–∞—á–∞—Ç–∞', 'sent');
            } catch (error) {
                addLog(`‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É: ${error.message}`, 'error');
                addLog('üí° –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ä–∞–∑—Ä–µ—à–∏–ª–∏ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É', 'info');
            }
        }

        function stopRecording() {
            console.log('stopRecording called', { mediaRecorder: !!mediaRecorder, isRecording, state: mediaRecorder?.state });
            
            if (!mediaRecorder) {
                addLog('‚ö†Ô∏è MediaRecorder –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'error');
                // –ü–æ–ø—Ä–æ–±—É–µ–º –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Ä—É—á–Ω—É—é
                if (audioStream) {
                    audioStream.getTracks().forEach(track => track.stop());
                }
                resetRecordingUI();
                return;
            }
            
            if (mediaRecorder.state === 'recording') {
                try {
                    mediaRecorder.stop();
                    addLog('‚èπ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–ø–∏—Å–∏...', 'info');
                } catch (e) {
                    addLog(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –∑–∞–ø–∏—Å–∏: ${e.message}`, 'error');
                }
            } else {
                addLog(`‚ö†Ô∏è MediaRecorder –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏: ${mediaRecorder.state}`, 'warn');
            }
            
            isRecording = false;
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ —Ç—Ä–µ–∫–∏
            if (audioStream) {
                audioStream.getTracks().forEach(track => {
                    track.stop();
                    console.log('Track stopped:', track.kind);
                });
                audioStream = null;
            }
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º AudioContext
            if (audioContext && audioContext.state !== 'closed') {
                audioContext.close().then(() => {
                    console.log('AudioContext closed');
                }).catch(e => {
                    console.error('Error closing AudioContext:', e);
                });
                audioContext = null;
            }
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é —É—Ä–æ–≤–Ω—è
            if (audioLevelInterval) {
                clearInterval(audioLevelInterval);
                audioLevelInterval = null;
            }
            
            resetRecordingUI();
            addLog('‚èπ –ó–∞–ø–∏—Å—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞', 'sent');
        }
        
        function resetRecordingUI() {
            const startBtn = document.getElementById('startRecordBtn');
            const stopBtn = document.getElementById('stopRecordBtn');
            
            startBtn.style.display = 'inline-block';
            startBtn.disabled = false;
            stopBtn.style.display = 'none';
            stopBtn.disabled = true;
            document.getElementById('audioStatus').textContent = '–°—Ç–∞—Ç—É—Å: –ù–µ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è';
            document.getElementById('audioLevelBar').style.width = '0%';
        }

        function updateAudioLevel() {
            if (!analyser) return;
            
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(dataArray);
            
            const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
            const level = Math.min(100, (average / 255) * 100);
            
            document.getElementById('audioLevelBar').style.width = level + '%';
        }

        async function sendRecordedAudio() {
            if (audioChunks.length === 0) {
                addLog('‚ö†Ô∏è –ù–µ—Ç –∑–∞–ø–∏—Å–∞–Ω–Ω–æ–≥–æ –∞—É–¥–∏–æ', 'error');
                return;
            }

            if (!ws || ws.readyState !== WebSocket.OPEN) {
                addLog('‚ö†Ô∏è WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω', 'error');
                return;
            }

            const audioBlob = new Blob(audioChunks, { type: 'audio/webm;codecs=opus' });
            addLog(`üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∞—É–¥–∏–æ: ${audioBlob.size} bytes`, 'sent');
            showPendingResponse();
            startPendingResponseTimer();
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –±–∏–Ω–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            ws.send(audioBlob);
            
            // –û—á–∏—â–∞–µ–º –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π –∑–∞–ø–∏—Å–∏
            audioChunks = [];
            document.getElementById('sendAudioBtn').disabled = true;
        }
        
        function formatBytes(bytes) {
            if (bytes < 1024) return `${bytes} B`;
            if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
            return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
        }

        function updateResponseBox(elementId, text) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            element.textContent = text || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
            element.classList.add('flash');
            if (highlightTimers[elementId]) {
                clearTimeout(highlightTimers[elementId]);
            }
            highlightTimers[elementId] = setTimeout(() => {
                element.classList.remove('flash');
            }, 1200);
        }

        function updateSttOutput(text) {
            updateResponseBox('sttOutput', text || '–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –Ω–µ –ø–æ–ª—É—á–µ–Ω–∞');
        }

        function updateLlmOutput(text) {
            updateResponseBox('llmOutput', text || '–û—Ç–≤–µ—Ç –º–æ–¥–µ–ª–∏ –ø—É—Å—Ç–æ–π');
        }

        function showPendingResponse() {
            const stt = document.getElementById('sttOutput');
            const llm = document.getElementById('llmOutput');
            if (stt) {
                stt.textContent = '‚è≥ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≥–æ–ª–æ—Å...';
                stt.classList.remove('flash');
            }
            if (llm) {
                llm.textContent = '‚è≥ –ñ–¥–µ–º –æ—Ç–≤–µ—Ç –º–æ–¥–µ–ª–∏...';
                llm.classList.remove('flash');
            }
        }

        function startPendingResponseTimer() {
            clearPendingResponseTimer();
            pendingResponseTimer = setTimeout(() => {
                addLog('‚è± –°–µ—Ä–≤–µ—Ä –¥–æ–ª–≥–æ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∞—É–¥–∏–æ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –±—ç–∫–µ–Ω–¥–∞.', 'error');
            }, 30000);
        }

        function clearPendingResponseTimer() {
            if (pendingResponseTimer) {
                clearTimeout(pendingResponseTimer);
                pendingResponseTimer = null;
            }
        }

        async function handleAudioResponse(blob) {
            const container = document.getElementById('audioResponses');
            if (!container) return;

            const placeholder = document.getElementById('audioPlaceholder');
            if (placeholder) {
                placeholder.remove();
            }

            const wrapper = document.createElement('div');
            wrapper.className = 'audio-response';

            const meta = document.createElement('div');
            meta.className = 'audio-response__meta';
            const timeSpan = document.createElement('span');
            timeSpan.textContent = new Date().toLocaleTimeString();
            const sizeSpan = document.createElement('span');
            sizeSpan.textContent = formatBytes(blob.size);
            meta.appendChild(timeSpan);
            meta.appendChild(sizeSpan);

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–æ—Ä–º–∞—Ç –∞—É–¥–∏–æ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∏–ª–∏ –≤—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const audioFormat = blob.detectedFormat || document.getElementById('audioFormat')?.value || 'opus';
            addLog(`üéµ –û–ø—Ä–µ–¥–µ–ª–µ–Ω —Ñ–æ—Ä–º–∞—Ç –∞—É–¥–∏–æ: ${audioFormat}`, 'info');
            
            // –ï—Å–ª–∏ —Ñ–æ—Ä–º–∞—Ç MP3, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π audio —ç–ª–µ–º–µ–Ω—Ç
            if (audioFormat === 'mp3') {
                addLog('üéµ –ü–æ–ª—É—á–µ–Ω MP3 –∞—É–¥–∏–æ –æ—Ç–≤–µ—Ç', 'info');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ MP3
                const arrayBuffer = await blob.arrayBuffer();
                const firstBytes = new Uint8Array(arrayBuffer.slice(0, 10));
                const isMp3 = firstBytes[0] === 0xFF && (firstBytes[1] & 0xE0) === 0xE0; // MP3 frame sync
                const isId3 = String.fromCharCode(firstBytes[0], firstBytes[1], firstBytes[2]) === 'ID3'; // ID3 tag
                
                addLog(`üîç –ü–µ—Ä–≤—ã–µ –±–∞–π—Ç—ã: ${Array.from(firstBytes.slice(0, 5)).map(b => '0x' + b.toString(16).padStart(2, '0')).join(' ')}`, 'info');
                
                if (!isMp3 && !isId3) {
                    addLog('‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –¥–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ MP3. –ü–µ—Ä–≤—ã–µ –±–∞–π—Ç—ã: ' + 
                        Array.from(firstBytes.slice(0, 5)).map(b => '0x' + b.toString(16).padStart(2, '0')).join(' '), 'warn');
                    console.warn('First bytes:', Array.from(firstBytes));
                    console.warn('Expected MP3 but got:', {
                        firstByte: '0x' + firstBytes[0].toString(16),
                        secondByte: '0x' + firstBytes[1].toString(16),
                        isMp3Sync: isMp3,
                        isId3: isId3
                    });
                } else {
                    addLog('‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω —Ñ–æ—Ä–º–∞—Ç MP3', 'info');
                }
                
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π Blob —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º MIME-—Ç–∏–ø–æ–º –¥–ª—è MP3
                // –í–∞–∂–Ω–æ: —Å–æ–∑–¥–∞–µ–º Blob –∏–∑ ArrayBuffer –Ω–∞–ø—Ä—è–º—É—é
                const mp3Blob = new Blob([arrayBuffer], { type: 'audio/mpeg' });
                addLog(`üì¶ –°–æ–∑–¥–∞–Ω MP3 Blob: ${mp3Blob.size} bytes, —Ç–∏–ø: ${mp3Blob.type}`, 'info');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ Blob —Å–æ–∑–¥–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ
                if (mp3Blob.size === 0) {
                    addLog('‚ùå –û—à–∏–±–∫–∞: Blob –ø—É—Å—Ç–æ–π!', 'error');
                    return;
                }
                
                // –°–æ–∑–¥–∞–µ–º URL –¥–ª—è Blob
                let audioUrl;
                try {
                    audioUrl = URL.createObjectURL(mp3Blob);
                    addLog(`üîó –°–æ–∑–¥–∞–Ω URL –¥–ª—è MP3: ${audioUrl}`, 'info');
                    if (audioUrl.includes('null')) {
                        addLog('‚ùå –û—à–∏–±–∫–∞: URL —Å–æ–¥–µ—Ä–∂–∏—Ç null! Blob —Å–æ–∑–¥–∞–Ω –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ.', 'error');
                        console.error('Blob details:', {
                            size: mp3Blob.size,
                            type: mp3Blob.type,
                            arrayBufferSize: arrayBuffer.byteLength
                        });
                    }
                } catch (e) {
                    addLog(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è URL: ${e.message}`, 'error');
                    console.error('URL creation error:', e);
                    return;
                }
                
                const audio = document.createElement('audio');
                audio.controls = true;
                audio.src = audioUrl;
                audio.preload = 'auto';
                
                // –û—á–∏—â–∞–µ–º URL –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
                audio.addEventListener('loadstart', () => {
                    addLog('üîÑ –ù–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏ MP3', 'info');
                });
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
                audio.addEventListener('loadstart', () => {
                    addLog('üîÑ –ù–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏ MP3', 'info');
                });
                audio.addEventListener('loadedmetadata', () => {
                    addLog(`‚úÖ MP3 –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã: ${audio.duration.toFixed(2)}s`, 'info');
                });
                audio.addEventListener('canplay', () => {
                    addLog('‚úÖ MP3 –≥–æ—Ç–æ–≤ –∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—é', 'info');
                });
                audio.addEventListener('play', () => {
                    addLog('‚ñ∂Ô∏è –ü—Ä–æ–∏–≥—Ä—ã–≤–∞–µ–º MP3 –∞—É–¥–∏–æ –æ—Ç–≤–µ—Ç', 'info');
                });
                audio.addEventListener('error', (e) => {
                    const error = audio.error;
                    let errorMsg = '‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è MP3';
                    if (error) {
                        switch(error.code) {
                            case error.MEDIA_ERR_ABORTED:
                                errorMsg += ': –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–µ—Ä–≤–∞–Ω–æ';
                                break;
                            case error.MEDIA_ERR_NETWORK:
                                errorMsg += ': –û—à–∏–±–∫–∞ —Å–µ—Ç–∏';
                                break;
                            case error.MEDIA_ERR_DECODE:
                                errorMsg += ': –û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è (–≤–æ–∑–º–æ–∂–Ω–æ, –¥–∞–Ω–Ω—ã–µ –Ω–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ MP3)';
                                break;
                            case error.MEDIA_ERR_SRC_NOT_SUPPORTED:
                                errorMsg += ': –§–æ—Ä–º–∞—Ç –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è';
                                break;
                            default:
                                errorMsg += `: –ö–æ–¥ –æ—à–∏–±–∫–∏ ${error.code}`;
                        }
                    }
                    addLog(errorMsg, 'error');
                    console.error('Audio error:', error, e);
                });

                const footer = document.createElement('div');
                footer.style.display = 'flex';
                footer.style.alignItems = 'center';
                footer.style.marginTop = '4px';

                const info = document.createElement('small');
                info.textContent = '–§–æ—Ä–º–∞—Ç: MP3';

                footer.appendChild(info);

                wrapper.appendChild(meta);
                wrapper.appendChild(audio);
                wrapper.appendChild(footer);
                container.prepend(wrapper);
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
                audio.addEventListener('canplay', () => {
                    audio.play().catch(e => {
                        addLog(`‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏: ${e.message}`, 'warn');
                        console.error('Play error:', e);
                    });
                }, { once: true });
                
                // Fallback: –ø—Ä–æ–±—É–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
                setTimeout(() => {
                    if (audio.readyState >= 2) { // HAVE_CURRENT_DATA
                        audio.play().catch(e => {
                            addLog(`‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ (fallback): ${e.message}`, 'warn');
                            console.error('Play error (fallback):', e);
                        });
                    }
                }, 500);
                
                return;
            }

            // –ü—ã—Ç–∞–µ–º—Å—è –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å Opus —á–µ—Ä–µ–∑ Web Audio API
            try {
                if (typeof OpusDecoder !== 'undefined' && opusDecoderAvailable) {
                    addLog('üîÑ –î–µ–∫–æ–¥–∏—Ä—É–µ–º Opus —á–µ—Ä–µ–∑ Web Audio API...', 'info');
                    
                    const arrayBuffer = await blob.arrayBuffer();
                    const opusData = new Uint8Array(arrayBuffer);
                    
                    addLog(`üì¶ –ü–æ–ª—É—á–µ–Ω–æ Opus –¥–∞–Ω–Ω—ã—Ö: ${opusData.length} bytes`, 'info');
                    console.log('Opus data preview:', Array.from(opusData.slice(0, 20)));
                    
                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–µ–∫–æ–¥–µ—Ä
                    const decoder = new OpusDecoder({
                        sampleRate: 48000,
                        channels: 1,
                        frameSize: 960, // 20ms –ø—Ä–∏ 48kHz
                    });
                    
                    addLog('üîÑ –î–µ–∫–æ–¥–∏—Ä—É–µ–º Opus –ø–∞–∫–µ—Ç—ã...', 'info');
                    
                    // –ü—Ä–æ–±—É–µ–º –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å raw Opus –ø–∞–∫–µ—Ç—ã
                    let decoded = null;
                    
                    try {
                        // –ü—Ä—è–º–æ–µ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ–≥–æ –±—É—Ñ–µ—Ä–∞
                        addLog('üîÑ –ü—Ä–æ–±—É–µ–º –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å –≤–µ—Å—å –±—É—Ñ–µ—Ä...', 'info');
                        console.log('Decoding opus data, length:', opusData.length);
                        console.log('First 50 bytes:', Array.from(opusData.slice(0, 50)));
                        
                        decoded = await decoder.decode(opusData);
                        addLog('‚úÖ –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ', 'info');
                        console.log('Decoded data structure:', decoded);
                        console.log('Decoded keys:', Object.keys(decoded));
                        
                        if (decoded.channelData) {
                            console.log('channelData type:', typeof decoded.channelData);
                            console.log('channelData length:', decoded.channelData.length);
                            if (decoded.channelData[0]) {
                                console.log('First channel type:', decoded.channelData[0].constructor.name);
                                console.log('First channel length:', decoded.channelData[0].length);
                            }
                        }
                    } catch (e1) {
                        addLog(`‚ö†Ô∏è –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å: ${e1.message}`, 'warn');
                        console.error('Decode error:', e1);
                        console.error('Error stack:', e1.stack);
                        throw e1;
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                    if (!decoded) {
                        throw new Error('–î–µ–∫–æ–¥–µ—Ä –≤–µ—Ä–Ω—É–ª null');
                    }
                    
                    // –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –º–æ–∂–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö
                    let channelData = null;
                    let sampleRate = 48000;
                    let samplesCount = 0;
                    
                    if (decoded.channelData && Array.isArray(decoded.channelData)) {
                        // –§–æ—Ä–º–∞—Ç: { channelData: Float32Array[], sampleRate: number }
                        channelData = decoded.channelData;
                        sampleRate = decoded.sampleRate || 48000;
                        samplesCount = channelData[0] ? channelData[0].length : 0;
                        addLog(`‚úÖ Opus –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω: ${samplesCount} samples, ${sampleRate}Hz, ${channelData.length} –∫–∞–Ω–∞–ª–æ–≤`, 'info');
                    } else if (decoded.samples && Array.isArray(decoded.samples)) {
                        // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: { samples: number[], sampleRate: number }
                        sampleRate = decoded.sampleRate || 48000;
                        samplesCount = decoded.samples.length;
                        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ Float32Array –∏ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º
                        const floatSamples = new Float32Array(decoded.samples.map(s => s / 32768.0));
                        channelData = [floatSamples];
                        addLog(`‚úÖ Opus –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç): ${samplesCount} samples, ${sampleRate}Hz`, 'info');
                    } else {
                        console.error('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:', decoded);
                        throw new Error('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –æ—Ç –¥–µ–∫–æ–¥–µ—Ä–∞');
                    }
                    
                    if (!channelData || channelData.length === 0 || samplesCount === 0) {
                        throw new Error('–î–µ–∫–æ–¥–µ—Ä –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ');
                    }
                    
                    // –°–æ–∑–¥–∞–µ–º AudioContext –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)({
                        sampleRate: sampleRate
                    });
                    
                    const audioBuffer = audioContext.createBuffer(
                        channelData.length,
                        samplesCount,
                        sampleRate
                    );
                    
                    // –ö–æ–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –≤ AudioBuffer
                    for (let channel = 0; channel < channelData.length; channel++) {
                        const bufferChannel = audioBuffer.getChannelData(channel);
                        const sourceData = channelData[channel];
                        
                        // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
                        if (sourceData instanceof Float32Array) {
                            bufferChannel.set(sourceData);
                        } else if (Array.isArray(sourceData)) {
                            bufferChannel.set(new Float32Array(sourceData));
                        } else {
                            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º Int16 –≤ Float32
                            const floatData = new Float32Array(sourceData.length);
                            for (let i = 0; i < sourceData.length; i++) {
                                floatData[i] = sourceData[i] / 32768.0;
                            }
                            bufferChannel.set(floatData);
                        }
                    }
                    
                    addLog('‚úÖ AudioBuffer —Å–æ–∑–¥–∞–Ω, –≥–æ—Ç–æ–≤ –∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—é', 'info');
                    console.log('AudioBuffer created:', {
                        channels: audioBuffer.numberOfChannels,
                        length: audioBuffer.length,
                        sampleRate: audioBuffer.sampleRate,
                        duration: audioBuffer.duration
                    });
                    
                    // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
                    const playButton = document.createElement('button');
                    playButton.textContent = '‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏';
                    playButton.style.marginRight = '10px';
                    playButton.style.padding = '5px 10px';
                    playButton.style.cursor = 'pointer';
                    playButton.style.background = '#28a745';
                    playButton.style.color = 'white';
                    playButton.style.border = 'none';
                    playButton.style.borderRadius = '3px';
                    
                    let currentSource = null;
                    playButton.onclick = async () => {
                        try {
                            if (audioContext.state === 'suspended') {
                                await audioContext.resume();
                                addLog('‚ñ∂Ô∏è AudioContext –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω', 'info');
                            }
                            
                            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å
                            if (currentSource) {
                                try {
                                    currentSource.stop();
                                } catch (e) {
                                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
                                }
                            }
                            
                            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫
                            currentSource = audioContext.createBufferSource();
                            currentSource.buffer = audioBuffer;
                            currentSource.connect(audioContext.destination);
                            
                            currentSource.start(0);
                            addLog('‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ Opus —á–µ—Ä–µ–∑ Web Audio API –Ω–∞—á–∞—Ç–æ', 'info');
                            playButton.disabled = true;
                            playButton.textContent = '‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è...';
                            
                            currentSource.onended = () => {
                                addLog('‚úÖ –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ', 'info');
                                playButton.disabled = false;
                                playButton.textContent = '‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏';
                                currentSource = null;
                            };
                            
                            currentSource.onerror = (error) => {
                                addLog(`‚ùå –û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è: ${error.message}`, 'error');
                                playButton.disabled = false;
                                playButton.textContent = '‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏';
                                currentSource = null;
                            };
                        } catch (error) {
                            addLog(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–∏: ${error.message}`, 'error');
                            console.error('Playback error:', error);
                            playButton.disabled = false;
                            playButton.textContent = '‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏';
                        }
                    };
                    
                    const footer = document.createElement('div');
                    footer.style.display = 'flex';
                    footer.style.alignItems = 'center';
                    footer.style.marginTop = '4px';
                    footer.appendChild(playButton);
                    
                    const info = document.createElement('small');
                    info.textContent = '–§–æ—Ä–º–∞—Ç: Opus (–¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ Web Audio API)';
                    footer.appendChild(info);
                    
                    wrapper.appendChild(meta);
                    wrapper.appendChild(footer);
                    container.prepend(wrapper);
                    
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
                    setTimeout(() => {
                        addLog('‚ñ∂Ô∏è –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ...', 'info');
                        playButton.click();
                    }, 300);
                    
                    return; // –£—Å–ø–µ—à–Ω–æ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–æ –∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–æ
                }
                
                // –ï—Å–ª–∏ OpusDecoder –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback
                if (typeof OpusDecoder === 'undefined' || !opusDecoderAvailable) {
                    addLog('‚ö†Ô∏è OpusDecoder –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback', 'warn');
                }
            } catch (error) {
                addLog(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è Opus: ${error.message}. –ò—Å–ø–æ–ª—å–∑—É–µ–º fallback.`, 'warn');
                console.error('Opus decoding error:', error);
                console.error('Error stack:', error.stack);
                console.error('Opus data length:', blob.size);
            }
            
            // Fallback: –æ–±—ã—á–Ω—ã–π audio —ç–ª–µ–º–µ–Ω—Ç (–º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å —Å raw Opus)
            const audio = document.createElement('audio');
            audio.controls = true;
            audio.src = URL.createObjectURL(blob);
            audio.preload = 'auto';
            audio.addEventListener('play', () => {
                addLog('‚ñ∂Ô∏è –ü—Ä–æ–∏–≥—Ä—ã–≤–∞–µ–º –∞—É–¥–∏–æ –æ—Ç–≤–µ—Ç', 'info');
            });
            audio.addEventListener('error', () => {
                addLog('‚ö†Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ Opus –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º. –°–∫–∞—á–∞–π—Ç–µ —Ñ–∞–π–ª –∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–Ω–µ—à–Ω–∏–π –ø–ª–µ–µ—Ä.', 'error');
            });

            const footer = document.createElement('div');
            footer.style.display = 'flex';
            footer.style.alignItems = 'center';
            footer.style.marginTop = '4px';

            const info = document.createElement('small');
            info.textContent = '–§–æ—Ä–º–∞—Ç: Opus (raw). –ï—Å–ª–∏ –Ω–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è, —Å–∫–∞—á–∞–π—Ç–µ —Ñ–∞–π–ª.';

            const downloadLink = document.createElement('a');
            downloadLink.href = audio.src;
            downloadLink.download = `llm-response-${Date.now()}.opus`;
            downloadLink.textContent = '–°–∫–∞—á–∞—Ç—å';
            downloadLink.style.marginLeft = 'auto';

            footer.appendChild(info);
            footer.appendChild(downloadLink);

            wrapper.appendChild(meta);
            wrapper.appendChild(audio);
            wrapper.appendChild(footer);

            container.prepend(wrapper);
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = () => {
            addLog('–ì–æ—Ç–æ–≤ –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é. –ù–∞–∂–º–∏—Ç–µ "–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è"', 'info');
            addLog('üí° –ü–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏ Hello –º–æ–∂–Ω–æ –Ω–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å –∞—É–¥–∏–æ', 'info');
        };
    </script>
</body>
</html>
